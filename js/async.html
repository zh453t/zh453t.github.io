<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="lib/public.css">
	<style title="contries">
		
		* {
			/* margin: 0; */
			/* padding: 0; */
			box-sizing: inherit;
		}

		html {
			box-sizing: border-box;
		}

		body {
			font-family: system-ui;
			color: #555;
			background-color: #f7f7f7;
			min-height: 100vh;
			position: relative;

			/* display: flex;
			align-items: center;
			justify-content: center; */
		}

		.container {
			display: flex;
			flex-flow: column;
			align-items: center;
			white-space:normal;
			font-size: 67.5%;
		}

		.countries {
			margin-bottom: 8rem;
			display: flex;

			font-size: 2rem;
			opacity: 0;
			transition: opacity 1s;
		}

		.country {
			background-color: #fff;
			box-shadow: 0 2rem 5rem 1rem rgba(0, 0, 0, 0.1);
			font-size: 1.8rem;
			width: 30rem;
			border-radius: 0.7rem;
			margin: 0 3rem;
			/* overflow: hidden; */
		}

		.neighbour::before {
			content: 'Neighbour country';
			width: 100%;
			position: absolute;
			top: -4rem;

			text-align: center;
			font-size: 1.8rem;
			font-weight: 600;
			text-transform: uppercase;
			color: #888;
		}

		.neighbour {
			transform: scale(0.8) translateY(1rem);
			margin-left: 0;
		}

		.country__img {
			width: 30rem;
			height: 17rem;
			object-fit: cover;
			background-color: #eee;
			border-top-left-radius: 0.7rem;
			border-top-right-radius: 0.7rem;
		}

		.country__data {
			padding: 2.5rem 3.75rem 3rem 3.75rem;
		}

		.country__name {
			font-size: 2.7rem;
			margin-bottom: 0.7rem;
		}

		.country__region {
			font-size: 1.4rem;
			margin-bottom: 2.5rem;
			text-transform: uppercase;
			color: #888;
		}

		.country__row:not(:last-child) {
			margin-bottom: 1rem;
		}

		.country__row span {
			display: inline-block;
			margin-right: 2rem;
			font-size: 2.4rem;
		}

		.btn-country {
			border: none;
			padding: 1rem 2.5rem;
			border-radius: 0.7rem;
			color: white;
			background-color: orangered;
			cursor: pointer;
		}

		.images {
			display: flex;
		}

		.images img {
			display: block;
			width: 80rem;
			margin: 4rem;
		}

		.images img.parallel {
			width: 40rem;
			margin: 2rem;
			border: 3rem solid white;
			box-shadow: 0 2rem 5rem 1rem rgba(0, 0, 0, 0.1);
		}

		.popup {
			min-width: 20em;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			padding: 1em 2em;

			#closePopup {
				padding: 0.2em 1em;
				margin-block: 0 0.5em
			}

			#errorText {
				font-weight: bold;
				color: darkred;
				font-size: large;
			}
		}

	</style>
	
	<title>async</title>
	<script src="lib/async.js" defer></script>
</head>

<body>
	<main class="container">
		<div class="countries">
			<!--
			<article class="country">
				<img class="country__img" src="" />
				<div class="country__data">
					<h3 class="country__name">COUNTRY</h3>
					<h4 class="country__region">REGION</h4>
					<p class="country__row"><span>ğŸ‘«</span>POP people</p>
					<p class="country__row"><span>ğŸ—£ï¸</span>LANG</p>
					<p class="country__row"><span>ğŸ’°</span>CUR</p>
				</div>
			</article>
			-->
		</div>
		<button class="btn-country">Where am I?</button>
		<div class="images"></div>
	</main>
	<dialog class="popup">
		<button id="closePopup">X</button>
		<p id="errorText"></p>
</dialog>
<hr>
<h3>AJaX</h3>
Asynchronous Javascript & XML
XML ç°åœ¨è°è¿˜ç”¨å•Š

Ajax æœ€å¸å¼•äººçš„ç‰¹æ€§æ˜¯å®ƒçš„â€œå¼‚æ­¥â€æ€§è´¨ï¼Œè¿™æ„å‘³ç€å®ƒå¯ä»¥ä¸æœåŠ¡å™¨é€šä¿¡ã€äº¤æ¢æ•°æ®å¹¶æ›´æ–°é¡µé¢ï¼Œè€Œæ— éœ€åˆ·æ–°é¡µé¢ã€‚

<b>åˆ›å»ºï¼š</b>
ä¼ ç»Ÿæ–¹æ³•ï¼š
const httpRequest = new XMLHttpRequest();
httpRequest.open(&lt;Method: string (ä¾‹ï¼šGET, POST, FETCH), URL: string>)
httpRequest.addEventListener('load', function() {
	// 
})

ä»€ä¹ˆå¹´ä»£äº†è¿˜åœ¨XMLHttpRequest?

const request = fetch(URL: string) 2015å¹´çš„ä¸œè¥¿a
è¿”å›ä¸€ä¸ª <a href="#promise">Promise</a>


<h4>Async: Asynchronous</h4>
a-synchronous: not synchronous
ä¸åŒæ­¥çš„
åŒæ­¥ï¼šæŒ‰ç…§ä»£ç çš„é¡ºåº

setTimeout()
æœ‰äº› eventListener
å’ŒæœåŠ¡å™¨æ²Ÿé€šéƒ½æ˜¯å¼‚æ­¥çš„
ä¸‹é¢çš„ä»£ç ä¼šé¦–å…ˆæ‰§è¡Œï¼Œå½“æ¡ä»¶æ»¡è¶³=æ—¶ä»£ç è‡ªåŠ¨æ‰§è¡Œ

æ€ä¹ˆè®©è¿™äº›æŒ‰é¡ºåºæ‰§è¡Œï¼Ÿ
setTimeout(() => {
	setTimeout(() => {
		setTimeout(() => {
			setTimeout(() => {

			}, 1000)
		}, 1000)
	}, 1000)
}, 1000)
å›è°ƒåœ°ç‹±

æ€ä¹ˆæ‘†è„±ï¼Ÿ
<b id="promise">Promise</b>
2014å¹´çš„ä¸œè¥¿

fetch() ä¼šåˆ›å»ºä¸€ä¸ª Promise
ä¹‹åï¼š
Promise.prototype.then(onSuccess, onFail)
Promise å®ä¾‹çš„ then() æ–¹æ³•æœ€å¤šæ¥å—ä¸¤ä¸ªå‚æ•°ï¼šç”¨äº Promise å…‘ç°å’Œæ‹’ç»æƒ…å†µçš„å›è°ƒå‡½æ•°ã€‚å®ƒç«‹å³è¿”å›ä¸€ä¸ªç­‰æ•ˆçš„ Promise å¯¹è±¡ï¼Œå…è®¸ä½ é“¾æ¥åˆ°å…¶ä»– Promise æ–¹æ³•ï¼Œä»è€Œå®ç°é“¾å¼è°ƒç”¨ã€‚
ä¸ç”¨ä½ æ‰‹åŠ¨å†™ return

ç‰¹åˆ«ï¼š fetch() çš„ Promise è¿”å›çš„å†…å®¹éœ€è¦ json()
  -> Response.json()
	-> <b>å®ƒè¿”å›ä¸€ä¸ª Promise</b>ï¼ŒPromise çš„è§£æ resolve ç»“æœæ˜¯å°†æ–‡æœ¬ä½“è§£æä¸º JSONã€‚

æ‰€ä»¥ fetch(url).then(request => request.json()).then(requestData => {

})

<h4>å‡ºé”™æ€ä¹ˆåŠ</h4>
<b>è®°å¾—</b>åœ¨æœ€ååŠ ä¸Š .catch()
Promise.prototype.then(err => {

})

<h4>403 404è¿™äº›æ€ä¹ˆåŠ</h4>
åœ¨request.json() é‚£é‡ŒåŠ ä¸Š
if (!request) <b>throw</b> new Error(errorText: string)
 -> throw è¯­å¥ç”¨æ¥æŠ›å‡ºä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰çš„å¼‚å¸¸ã€‚å½“å‰å‡½æ•°çš„æ‰§è¡Œå°†è¢«åœæ­¢ï¼ˆthrow ä¹‹åçš„è¯­å¥å°†ä¸ä¼šæ‰§è¡Œï¼‰
 -> Error() å’Œä»»ä½•ä¸€ä¸ªå¯¹è±¡æ„é€ å™¨ (object constructor) ä¸€æ ·ï¼Œä¼ å…¥çš„æ˜¯æ–°é”™è¯¯çš„æ–‡æœ¬


<h2>åˆ›å»º Promise</h2>
new Promise(executor(resolve: function, reject: function): function)

const lotteryPromise = new Promise(function(resolve<i>: function</i>, reject<i>: function</i>) {
	if(Math.random() >= 0.5) resolve(resolvedValue<i>: string</i>)
})

resolve() æŠŠ Promise çš„çŠ¶æ€è®¾æˆ fulfilled
resolve(resolvedValue)
 -> è¿”å› resolvedValue ï¼Œä¼ å…¥ then()

 lotteryPromise.then(result => console.log(result))


<h2>async function å’Œ await</h2>
2017å¹´çš„ä¸œè¥¿
æ˜¯ Promise.then().then().then().then().then()
await æ“ä½œç¬¦ç”¨äºç­‰å¾…ä¸€ä¸ª Promise å…‘ç°å¹¶è·å–å®ƒå…‘ç°ä¹‹åçš„å€¼ã€‚å®ƒåªèƒ½åœ¨å¼‚æ­¥å‡½æ•°æˆ–è€…æ¨¡å—é¡¶å±‚ä¸­ä½¿ç”¨ã€‚

å¼‚æ­¥å‡½æ•°ï¼š
è¢«è°ƒç”¨åï¼Œ<b>æ°¸è¿œ</b>è¿”å›ä¸€ä¸ª Promise, å‡½æ•°æ­£å¸¸çš„è¿”å›å€¼ï¼ˆç”¨ return è¯­å¥å†™çš„é‚£ä¸ªï¼‰æ˜¯ Promise çš„ fulfilledValue

å¹¶è¡Œï¼š <b>Promise.all()</b>
Promise() çš„é™æ€æ–¹æ³•
Promise.all(iterable)
Promise.all() æ¥æ”¶ä¸€ä¸ªæ•°ç»„ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„
ä½†æ˜¯ï¼Œ åªè¦ä¸€ä¸ª Promise å‡ºç°é”™è¯¯(æˆ–è€…è¢«æ‹’ç»?)ï¼Œ all()å°±ç«‹å³ç»“æŸæ‰§è¡Œï¼Œ çŸ­è·¯

<b>Promise.race()</b>
æ¯”èµ›ï¼šè°å…ˆæ•²å®š/å…‘ç°(settled)è¿”å›è°çš„å€¼
ä¹Ÿä¼šçŸ­è·¯ï¼Œå’Œä¸Šé¢ä¸€æ ·

Promise.allSettled()
2020å¹´çš„ä¸œè¥¿
å’Œ Promise.all() å·®ä¸å¤š
ä½†æ˜¯æ— è®º Promise æ˜¯å¦ resolved (å…‘ç°)ï¼Œéƒ½ä¼šè¿”å›ç»“æœ

Promise.any()
å°† [Promise1, Promise2, Promise3... ] ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¿”å›ä¸€ä¸ª Promiseã€‚
å½“è¾“å…¥çš„ä»»ä½•ä¸€ä¸ª Promise å…‘ç°æ—¶ï¼Œè¿™ä¸ªè¿”å›çš„ Promise å°†ä¼šå…‘ç°ï¼Œå¹¶è¿”å›ç¬¬ä¸€ä¸ªå…‘ç°çš„å€¼ã€‚å½“æ‰€æœ‰è¾“å…¥ Promise éƒ½è¢«æ‹’ç»ï¼ˆåŒ…æ‹¬ä¼ é€’äº†ç©ºçš„å¯è¿­ä»£å¯¹è±¡ï¼‰æ—¶ï¼Œå®ƒä¼šä»¥ä¸€ä¸ªåŒ…å«æ‹’ç»åŸå› æ•°ç»„çš„ AggregateError æ‹’ç»ã€‚

å¼‚æ­¥çš„è¦await!!!
<h1>try ... catch</h1>
æŸ¥é”™æœºåˆ¶
2004ä¹‹å‰çš„ä¸œè¥¿
</body>
</html>